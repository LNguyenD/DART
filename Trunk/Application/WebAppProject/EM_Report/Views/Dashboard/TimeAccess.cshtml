@*Start-Count time to access Dashboard Level*@
<script type="text/javascript" language="javascript">
    var count = 0;
    var starttime;
    var url = $(location).attr('href');

    $(window).load(function () {
        saveStartTime();
    });

    $(window).bind('beforeunload', function () {
        count++;
        if (count == 1) {
            var currentTab = $('.tab_current');
            submitTimeInfo(currentTab);
        }
    });

    function saveStartTime() {
        // set current time as start info
        starttime = getCurrentDate();
    }

    // option:
    // '1': CPR Raw;
    // '2': in Advance option mode
    function submitTimeInfo(currentTab, option) {
        // find the start position of params query string        
        var iParamStart = document.URL.indexOf("?");
        if (iParamStart >= 0) {
            var urlParamStr = document.URL.substr(iParamStart + 1);
            if (urlParamStr != "") {
                // set current time as end info
                var endtime = getCurrentDate();
                
                // CPR report or Dashboard Raw data
                if (option == '1' || option == '2'
                    || currentTab.attr('id') == "tab_graph"
                    || currentTab.attr('id') == "tab_claim"
                    || currentTab.attr('id') == "tab_all_claim") {
                   
                    var reportFrameID;
                    if (option == '1') {
                        reportFrameID = "ifRaw";
                    }
                    else {
                        reportFrameID = getCurrentCPRFrameID(currentTab, option);
                    }
                    
                    var reportFrame = $("iframe[id=" + reportFrameID + "]");
                    if (reportFrame != null) {
                        var reportSrc = reportFrame.attr("src");
                        iParamStart = reportSrc.indexOf("?");
                        if (iParamStart >= 0) {
                            // reset url params string
                            urlParamStr = reportSrc.substr(iParamStart + 1);
                        }
                    }
                }

                // set Url
                url = urlParamStr;
                
                if (currentTab.length > 0) {
                    url = getCurrentTabUrl(currentTab, url);
                }

                // post data to server
                $.ajax({
                    type: 'POST',
                    headers: generateAntiForgeryTokenHeader(),
                    url: '@Url.Action("Details", "Dashboard_TimeAccess")',
                    data:
                        {
                            url: url,
                            starttime: starttime,
                            endtime: endtime,
                        },
                    success: function () {
                    }
                });
            }
        }
    }

    function getCurrentTabUrl(currentTab, currentUrl) {
        var type = currentTab.attr('id').replace('tab_', '');
        var newUrl = currentUrl;

        // correct type info:
        // TMF
        if (document.URL.toLowerCase().indexOf('tmf') > -1) {
            if (type == "agencies") {
                newUrl = currentUrl.replace(new RegExp("group", "g"), 'agency');
            }
            else if (type == "group") {
                newUrl = currentUrl.replace(new RegExp("agency", "g"), 'group');
            }
        }
        // EML
        else if (document.URL.toLowerCase().indexOf('eml') > -1) {
            if (type == "agencies") {
                newUrl = currentUrl.replace(new RegExp("group", "g"), 'employer_size')
                        .replace(new RegExp("account_manager", "g"), 'employer_size');
            }
            else if (type == "group") {
                newUrl = currentUrl.replace(new RegExp("employer_size", "g"), 'group')
                        .replace(new RegExp("account_manager", "g"), 'group');
            }
            else if (type == "account_manager") {
                newUrl = currentUrl.replace(new RegExp("employer_size", "g"), 'account_manager')
                        .replace(new RegExp("group", "g"), 'account_manager');
            }
        }
        // HEM
        else if (document.URL.toLowerCase().indexOf('hem') > -1) {
            if (type == "agencies") {
                newUrl = currentUrl.replace(new RegExp("group", "g"), 'portfolio');
            }
            else if (type == "group") {
                newUrl = currentUrl.replace(new RegExp("portfolio", "g"), 'group');
            }
        }

        return newUrl;
    }

    function getCurrentCPRFrameID(currentTab, option) {
        var frameID;
       
        if (currentTab.attr('id') == "tab_graph") {
            frameID = "ifRaw";
        }
        else if (currentTab.attr('id') == "tab_claim") {
            frameID = "ifRaw2";
        }
        else if (currentTab.attr('id') == "tab_all_claim") {
            frameID = "ifRaw3";
        }
        else {
            if(document.URL.indexOf('level2') >= 0)
            {
                if (option == '2') {
                    // Advance option mode                    
                    if (currentTab.attr('id').replace('tab_', '') == 'portfolio' || currentTab.attr('id').replace('tab_', '') == 'employer_size') {
                        frameID = "ifTableReport_advance_agency";
                    }
                    else if (currentTab.attr('id').replace('tab_', '') == 'account_manager') {
                        frameID = "ifTableReport_advance_accountmanager";
                    }
                    else {
                        frameID = "ifTableReport_advance_" + currentTab.attr('id').replace('tab_', '');
                    }
                }
                else {
                    // Dashboards
                    frameID = "ifReport";
                    var type = currentTab.attr('id').replace('tab_', '');

                    if (type == "agencies") {
                        frameID += "_Agency";
                    }
                    else if (type == "group") {
                        frameID += "_Group";
                    }
                    else if (type == "account_manager") {
                        frameID += "_AccountManager";
                    }
                }
            }
            else if (document.URL.indexOf('level3') >= 0
                    || document.URL.indexOf('level4') >= 0) {
                if (option == '2') {
                    if (document.URL.indexOf('account_manager') >= 0) {
                        frameID = "ifTableReport_advance_accountmanager";
                    }
                    else if (document.URL.indexOf('portfolio') >= 0
                        || document.URL.indexOf('employer_size') >= 0) {
                        frameID = "ifTableReport_advance_agency";
                    }
                    else if(document.URL.indexOf('group') >= 0){
                        frameID = "ifTableReport_advance_group";
                    }
                    else {
                        frameID = "ifTableReport_advance_agency";
                    }
                }
                else
                {
                    // Dashboards
                    frameID = "ifReport";
                    var type = currentTab.attr('id').replace('tab_', '');

                    if (type == "agencies") {
                        frameID += "_Agency";
                    }
                    else if (type == "group") {
                        frameID += "_Group";
                    }
                    else if (type == "account_manager") {
                        frameID += "_AccountManager";
                    }
                }
            }

        }
        
        return frameID;
    }
   
    function getCurrentDate() {
        var time = new Date();
        var year = time.getFullYear().toString();
        var month = (time.getMonth() + 1).toString();
        var day = time.getDate().toString();
        var hour = time.getHours().toString();
        var minutes = time.getMinutes().toString();
        var seconds = time.getSeconds().toString();

        return year + "-" + month + "-" + day + " " + hour + ":" + minutes + ":" + seconds;
    }
</script>
@*End-Count time to access Dashboard Level*@