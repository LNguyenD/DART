@model IEnumerable<EM_Report.Models.Organisation_Levels_Model>
@using EM_Report.BLL.Pager;
@using EM_Report.BLL.Commons;
@using EM_Report.Helpers;
@using EM_Report.Models;
@using EM_Report.BLL.Services;
@{
    ViewBag.Title = "Organisation Level";
    ViewBag.Heading = "Report >> Organisation Role Level List";
    Layout = Request.IsAjaxRequest() ? null : "~/Views/Shared/_Master.cshtml";
    I_Organisation_RolesService roleService = new Organisation_RolesService(Base.LoginSession);
    var idx = 0;
    var idxC = 0;
}   
<link href="@Url.Stylesheet("report.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Stylesheet("level.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Stylesheet("jquery/jquery.ui.all.css")" rel="stylesheet" type="text/css" />
<script src="@Url.Content("~/scripts/jquery.ui.core.js")") type="text/javascript"></script>
<script src="@Url.Content("~/scripts/jquery.ui.widget.js")" type="text/javascript"></script>
<script src="@Url.Content("~/scripts/jquery.ui.mouse.js")" type="text/javascript"></script>
<script src="@Url.Content("~/scripts/jquery.ui.sortable.js")" type="text/javascript"></script>
<script src="@Url.Content("~/scripts/jquery.ui.droppable.js")" type="text/javascript"></script>
<script src="@Url.Content("~/scripts/jquery.ui.tabs.js")" type="text/javascript"></script>
<div class="Wrapper" id="tabs" >
	<ul class="BoxHeader level-list">
		@foreach (var item in (IQueryable<Organisation_Levels_Model>)ViewBag.LevelList)
        {
            string Name = "Level " + idx.ToString();
            if (idx == 0)
            {                     
                <li id="level-@(item.LevelId)" class="level-arrow-select-left">
                    <a href="#tabs-@(idx)">@Name</a>
                </li>  
            }
            else if (idx == 1)
            {                      
                <li id="level-@(item.LevelId)" class="level-arrow-select-right">
                   <a href="#tabs-@(idx)">@Name</a>
                </li>  
            }
            else
            {
                <li id="level-@(item.LevelId)" class="level-arrow">
                   <a href="#tabs-@(idx)">@Name</a>
                </li>  
            }
            idx++;
        }               
        <li class="level-arrow-last">
           <a style="cursor:default" href="#tabs-2"></a>
        </li>         
	</ul>    
    @foreach (var item in (IQueryable<Organisation_Levels_Model>)ViewBag.LevelList)
    {
           var lstRoleOfLevel = roleService.GetRoleOfLevel(item.LevelId);           
           <div class="FormWrapper role-wrapper" id="tabs-@(idxC)">                
                <div class="level-role-title">
                    <a href="@Url.Action("details", "level", new { id = item.LevelId })">@(item.Name + (item.Status == 1 ? "" : " (" + item.StatusName + ")"))</a>    
                </div>
                <ul id="sortable@(idxC)" class="connectedSortable ui-helper-reset">                 
                   @foreach (var i in lstRoleOfLevel)
                   {
                       <li id="role-@(i.Organisation_RoleId)" class="level-role">
                            <a href="@Url.Action("details/" + i.Organisation_RoleId + "", "organisation")"> + @(i.Name + (i.Status == 1 ? "" : " (" + i.StatusName + ")"))  </a>                        
                        </li>
                   }
                </ul> 
           </div>  
           idxC++;
    }
         
    <div class="Paging">       
    @if (Login.AuthorizeSystemPermission(ResourcesHelper.System_Group, ResourcesHelper.Permission_Add))
    {
        <a class="CmdButton Add" href="@Url.Action("details", "organisation")">Add New Organisation</a>
    }
    @if (Login.AuthorizeSystemPermission(ResourcesHelper.System_Group, ResourcesHelper.Permission_Add))
    {
        <a class="CmdButton Add" href="@Url.Action("details", "level")">Add New Level</a>
    }                    
    </div>	    
</div>
<script type="text/javascript">
    $(function () {
        $("#tabs").tabs().find(".ui-tabs-nav").sortable({
            items: "> li:not(:last)",
            stop: function (event, ui) {               
                $.post("organisation_level", { itype: "level", data: $('li[id*=level-]').map(function (index) { return this.id.replace("level-", "") + "|" + index; }).get().join(',') }, function (data) { });                
                $("#" + $(".level-arrow-select-left").children("a").attr("href").replace("#", "")).removeClass().addClass("FormWrapper role-wrapper ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide");
                ResetSelectedTab(ui.item);
                $("#" + ui.item.children("a").attr("href").replace("#", "")).removeClass().addClass("FormWrapper role-wrapper ui-tabs-panel ui-widget-content ui-corner-bottom");
            }
        });
        $("ul[id*=sortable]").sortable().disableSelection();

        var $tabs = $("#tabs").tabs();

        var $tab_items = $("ul:first li", $tabs).droppable({
            accept: ".connectedSortable li",
            tolerance: "pointer",
            drop: function (event, ui) {
                var $item = $(this);
                var $list = $($item.find("a").attr("href"))
					.find(".connectedSortable");

                ui.draggable.hide("slow", function () {
                    $tabs.tabs("select", $tab_items.index($item));
                    $(this).appendTo($list).show("slow");
                });
                ResetSelectedTab($item);
                $.post("organisation_level", { itype: "role", lid: $item.attr("id").replace("level-", ""), rid: ui.draggable.attr("id").replace("role-", "") });
            }
        });

        $('.level-list >li >a').not(':last').bind('click', function () {
            ResetSelectedTab($(this).parent());
        });
    });

    function ResetSelectedTab(el) {
        $('.level-arrow-select-left').removeClass().addClass("level-arrow ui-state-default ui-corner-top ui-droppable");
        $('.level-arrow-select-right').removeClass().addClass("level-arrow ui-state-default ui-corner-top ui-droppable");
        $(el).removeClass().addClass("level-arrow-select-left ui-state-default ui-corner-top ui-droppable");
        $(el).next().removeClass().addClass("level-arrow-select-right ui-state-default ui-corner-top ui-droppable");
    } 
</script>